version: 0.2
phases:
  install:
    runtime-versions:
      nodejs: 12
    commands:
      - whoami
      - npm --version
      - node --version
      - npm install -g npm@7.24
      - n 16.10.0
      - npm --version
      - node --version      
      - yum install -y jq
      - npm install -g selenium-side-runner
      - wget https://chromedriver.storage.googleapis.com/90.0.4430.24/chromedriver_linux64.zip
      - unzip chromedriver_linux64.zip
      - cp chromedriver $TestDirectory/chromedriver
      - mv chromedriver /usr/bin/chromedriver   
      - npm install -g anypoint-cli@latest
  build:
    commands:
      - pwd
      - MulesoftAccountSecret=$(aws secretsmanager get-secret-value --secret-id $EnvironmentSecret --query SecretString --output text | jq -rR 'fromjson? | .ArgOne')
      - anypoint_username=$(aws secretsmanager get-secret-value --secret-id $MulesoftAccountSecret --query SecretString --output text | jq -rR 'fromjson? | .username')
      - anypoint_password=$(aws secretsmanager get-secret-value --secret-id $MulesoftAccountSecret --query SecretString --output text | jq -rR 'fromjson? | .password')
      - export ANYPOINT_USERNAME=$anypoint_username
      - export ANYPOINT_PASSWORD=$anypoint_password
      - ls
      - cd $TestDirectory
      - TestIp=$(anypoint-cli runtime-mgr cloudhub-application describe-json  --environment=$Env $CompanyName-$SystemName-$SystemComponent-$Env | jq -r .fullDomain)/helloWorld
      - |
        echo -e "Checking if deployment installation was successful"
        echo "DNS to test is $TestIp";
        selenium-side-runner --output-directory . --base-url http://$TestIp -c "browserName=chrome goog:chromeOptions.args=[disable-infobars, headless, no-sandbox]" --debug --timeout 15000 *.side
        ls
        cat *.json
