version: 0.2

phases:
  install:
    commands:
      - yum install -y jq
  build:
    commands:
      - ls
      - DeploymentSubnets="1,2"
      - echo $DeploymentSubnets
      - echo $H
      - echo $I
      - BUILD_NUMBER=$J
      - echo $BUILD_NUMBER
      - cp $E injected-parameters.json
      - |
        sed -i  "s/#BlueBuildNumber/$BUILD_NUMBER/g" injected-parameters.json;
        sed -i  "s/#GreenBuildNumber/$buildInService/g" injected-parameters.json
        sed -i  "s/#PipelineName/$B/g" injected-parameters.json;
        sed -i  "s/#Env/$D/g" injected-parameters.json;
        sed -i  "s/#AmiId/$L/g" injected-parameters.json;
        sed -i  "s/#SourcePortNumber/$Q/g" injected-parameters.json;
        sed -i  "s/#InstanceType/$M/g" injected-parameters.json;
        sed -i  "s/#KeyPairName/$N/g" injected-parameters.json;
        sed -i  "s/#SecurityGroup/$P/g" injected-parameters.json;
        sed -i  "s/#NameTagPrefix/$K/g" injected-parameters.json;
        sed -i  "s~#PermissionsBoundary~$O~g" injected-parameters.json;
        sed -i  "s/#SystemComponent/$C/g" injected-parameters.json;
        sed -i  "s/#SystemName/$SystemName/g" injected-parameters.json;
        sed -i  "s~#RepositoryUri~$R~g" injected-parameters.json;
        sed -i  "s~#ArgOne~$G~g" injected-parameters.json;
        sed -i  "s~#Subnet~$SubnetBlue~g" injected-parameters.json;

      - cat injected-parameters.json; 
      - cat $F;
      - |
        if ! aws cloudformation describe-stacks --stack-name $I ; then
          echo -e "\nStack does not exist, creating ..."
          aws cloudformation create-stack --stack-name $I --template-body file://$F --parameters file://injected-parameters.json --capabilities CAPABILITY_NAMED_IAM
          echo "Waiting for stack to be created ..."
          aws cloudformation wait stack-create-complete --stack-name $I 
        else
          echo -e "\nStack exists, attempting update ..."
          aws cloudformation update-stack --stack-name $I --template-body file://$F --parameters file://injected-parameters.json --capabilities CAPABILITY_NAMED_IAM
          echo "Waiting for stack to be updated ..."
          aws cloudformation wait stack-update-complete --stack-name $I
        fi 
